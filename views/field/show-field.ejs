<% layout('layout/boilerplate.ejs') %>

<div class="container">
  <h1><%= field.name %></h1>
  <h2>Rp<%=field.price %></h2>

  <% if(field.images.length > 0){%>
  <div id="carouselExample" class="carousel slide my-2">
    <div class="carousel-inner">
      <% field.images.forEach((img, i) => { %>
      <div class="carousel-item <%= i === 0 ? 'active' : '' %>">
        <img crossorigin="anonymous" src="<%= img.url %>" class="d-block w-100" style="height: 600px; object-fit: cover" />
      </div>
      <% }); %>
    </div>

    <% if(field.images.length > 1) {%>
    <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Previous</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Next</span>
    </button>

    <% }%>
  </div>

  <% }%>

  <form action="" method="GET" id="date-picker-form">
    <input type="hidden" id="field-id" value="<%= field.fieldID %>" />
    <input type="date" name="" id="booking-date-picker" value="<%= queryDateStr %>" min="<%= minDate %>" max="<%= maxDate %>" />
  </form>

  <h3 class="my-2" id="selected-date">
    <%= queryDateFormatted %>
    <p><%= minutesToHHMM(field.openTime) %> - <%= minutesToHHMM(field.closeTime) %></p>
  </h3>
</div>

<form action="/fields/<%= field.fieldID %>/users/booking" method="POST" class="container" id="form-booking">
  <input type="hidden" name="date" id="selected-booking-date" value="<%= queryDateStr %>" />

  <div class="my-2">
    <%for(let slot of timeSlots){%>
    <div class="btn-group my-1" role="group" aria-label="Basic checkbox toggle button group">
      <% if(successBook && successBook.has(slot)){%>
      <input type="checkbox" class="btn-check" id="slot-<%= slot  %>" name="slots" value="<%= slot %>" disabled />
      <label class="btn btn-outline-danger" for="slot-<%=slot%>" aria-disabled="true">
        <p class="mb-1"><b><%= minutesToHHMM(slot) %> - <%= minutesToHHMM(slot + 60) %></b></p>

        <% if(currUser && currUser.user_id === successBook.get(slot).bookedBy && successBook.get(slot).status === 'success'){%>
        <span><a>My Book</a></span>
        <% } else if(currUser && currUser.user_id === successBook.get(slot).bookedBy && successBook.get(slot).status === 'pending'){%>
        <span><a>My Reserved</a></span>
        <p><a>Expired in: <%= successBook.get(slot).reservedTime %> Minutes </a></p>

        <% } else{%>
        <span><b>Booked</b></span>
        <% }%>
      </label>
      <% } else {%>
      <input type="checkbox" class="btn-check" id="slot-<%= slot  %>" name="slots" value="<%= slot %>" />
      <label class="btn btn-outline-primary" for="slot-<%=slot%>">
        <p class="mb-1"><b><%= minutesToHHMM(slot) %> - <%= minutesToHHMM(slot + 60) %></b></p>

        <span><b>Available</b></span>
      </label>
      <%}%>
      </div>
      <%}%>
    </div>

    <% if(!currUser){%>

    <span class="d-block text-body-secondary mb-3"><em>Please <a class="text-reset" href="/login">sign-in</a> first before booking</em></span>

    <% } else {%>
    <button class="btn btn-success">Book</button>

    <% }%>
</form>

<%if(currUser && currUser.role === 'user'){%>

<div class="container my-4 d-flex flex-row" style="width: 100%">
  <div class="card card-body" style="width: 50%">
    <form action="/fields/<%= field.fieldID %>/review" method="POST">
      <div class="mb-3 d-flex flex-column">
        <label for="review_text" class="form-label">Your Review</label>
        <textarea name="text" id="review_text" placeholder="Leave your review" rows="8" cols="50" class="p-2" required></textarea>
      </div>

      <div class="mb-3">
        <label for="review_rating" class="form-label">Rating</label>
        <input type="number" class="form-control" id="review_rating" name="rating" required min="1" max="5" step="0.5" value="1" />
      </div>

      <button class="btn btn-success">Submit</button>
    </form>
  </div>

  <div class="container" style="width: 50%">
    <%if(field.reviews.length > 0){%> <% for(rev of field.reviews){%>
    <div class="card mb-2">
      <div class="card-body">
        <h6><b><%= rev.user.username.toUpperCase() %></b></h6>
        <p class="my-1"><%= rev.text %></p>
        <b><%= rev.rating %>‚≠ê</b>

        <% if(rev.user._id.toString() === currUser.user_id.toString()){%>
        <form action="/fields/<%= field.fieldID %>/review/<%= rev.reviewID %>?_method=DELETE" method="POST">
          <button class="btn btn-danger mt-2">Delete</button>
        </form>
        <% }%>
      </div>
    </div>
    <% }%> <%} else {%>
    <h2 class="text-center" style="margin-top: 30%">Be the first to leave a review!</h2>
    <% }%>
  </div>
</div>

<%}%>

   <script src="/js/showField.js"></script>
</div>