<% layout('layout/boilerplate.ejs') %>

<link rel="stylesheet" href="/css/transaction-history.css">

<div class="container py-5">

  <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
    <div>
      <h1 class="page-title text-uppercase mb-1">
        <% if(currUser.role === 'admin') { %>
        <i class="bi bi-receipt-cutoff me-2"></i> All Transactions
        <% } else { %>
        <i class="bi bi-clock-history me-2"></i> Booking History
        <% } %>
      </h1>
      <p class="text-muted mb-0">Manage and track all booking activities.</p>
    </div>
  </div>

  <div class="card border-0 shadow-sm mb-4 filter-card">
    <div class="card-body p-3">
      <form method="GET" class="row g-3 align-items-center">
        <div class="col-md-4 col-lg-3">
          <div class="input-group">
            <span class="input-group-text bg-white border-end-0"><i class="bi bi-funnel-fill text-muted"></i></span>
            <select name="status" class="form-select bg-white border-start-0 ps-0" onchange="this.form.submit()">
              <option value="all" <%= statusFilter === 'all' ? 'selected' : '' %>>All Status</option>
              <% if(currUser.role === 'user'){ %>
              <option value="pending" <%= statusFilter === 'pending' ? 'selected' : '' %>>Pending Payment</option>
              <% } %>
              <option value="success" <%= statusFilter === 'success' ? 'selected' : '' %>>Completed</option>
              <option value="failed" <%= statusFilter === 'failed' ? 'selected' : '' %>>Failed/Cancelled</option>
            </select>
          </div>
        </div>
        <input type="hidden" name="limit" value="<%= limit %>">
      </form>
    </div>
  </div>

  <% if(bookings.length === 0){ %>

  <div class="text-center py-5 empty-state">
    <div class="mb-3">
      <i class="bi bi-inbox display-1 text-light-gray"></i>
    </div>
    <h4 class="text-muted">No transactions found</h4>
    <p class="text-muted small">Try changing the filter or create a new booking.</p>
    <% if(currUser.role === 'user'){ %>
    <a href="/fields" class="btn btn-apex-primary mt-3 px-4 rounded-pill">Book a Field</a>
    <% } %>
  </div>

  <% } else { %>

  <div class="transaction-list">
    <% bookings.forEach((booking) => { %>

    <% 
           let statusClass = "";
           let iconClass = "";
           
           if(booking.status === "success") {
              statusClass = "bg-success-subtle text-success border-success-subtle";
              iconClass = "bi-check-circle-fill";
           } else if(booking.status === "failed") {
              statusClass = "bg-danger-subtle text-danger border-danger-subtle";
              iconClass = "bi-x-circle-fill";
           } else if(booking.status === "pending") {
              statusClass = "bg-warning-subtle text-warning-emphasis border-warning-subtle";
              iconClass = "bi-hourglass-split";
           }
        %>

    <div class="card transaction-card mb-3 border-0 shadow-sm">
      <div class="card-body p-4">
        <div class="row align-items-center g-3">

          <div class="col-lg-3 col-md-6">
            <div class="d-flex align-items-center">
              <div class="field-icon-box me-3">
                <i class="bi bi-geo-alt-fill"></i>
              </div>
              <div>
                <h6 class="mb-1 fw-bold text-dark text-truncate" style="max-width: 180px;">
                  <%= booking.field_name || 'Unknown Field' %>
                </h6>
                <small class="text-muted d-block">
                  <i class="bi bi-calendar3 me-1"></i> <%= formattedDate(booking.date) %>
                </small>
              </div>
            </div>
          </div>

          <div class="col-lg-2 col-md-6">
            <div class="d-flex flex-column">
              <span class="text-muted small mb-1">Time Slot</span>
              <span class="fw-bold text-dark">
                <%= minutesToHHMM(booking.start_time) %> - <%= minutesToHHMM(booking.end_time) %>
              </span>
            </div>
          </div>

          <div class="col-lg-2 col-6">
            <div class="d-flex flex-column">
              <span class="text-muted small mb-1">Total Paid</span>
              <span class="fw-bold text-apex-green">
                Rp<%= formatPrice(booking.total_price) %>
              </span>
            </div>
          </div>

          <div class="col-lg-2 col-6">
            <div class="d-flex flex-column">
              <span class="text-muted small mb-1">Customer</span>
              <span class="fw-bold text-dark text-truncate d-block">
                <%= booking.u_username ? booking.u_username:booking.manual_name %>
              </span>
            </div>
          </div>

          <div class="col-lg-3 col-12 text-md-end">
            <div class="d-flex flex-column align-items-start align-items-md-end gap-2">
              <span class="badge rounded-pill px-3 py-2 border <%= statusClass %>">
                <i class="bi <%= iconClass %> me-1"></i> <%= booking.status.toUpperCase() %>
              </span>

              <div class="mt-1">
                <% if(currUser.role === 'user') { %>
                <% if(booking.status === 'pending') { %>
                <a href="/payment/create/<%= booking.booking_id %>" class="btn btn-sm btn-apex-accent rounded-pill px-3">Pay Now</a>
                <form action="/payment/cancel/<%= booking.booking_id %>" method="POST" class="d-inline ms-1">
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                  <button class="btn btn-sm btn-outline-danger rounded-pill px-3 border-0">Cancel</button>
                </form>
                <% } else if (booking.status === 'success') { %>
                <a href="/payment/details/<%= booking.booking_id %>" class="btn btn-sm btn-outline-secondary rounded-pill px-3">Receipt</a>
                <% } %>
                <% } %>

                <% if(currUser.role === 'admin' && booking.status === 'success') { %>
                <a href="/admin/analytics/transactions-history/details/<%= booking.booking_id %>" class="btn btn-sm btn-outline-dark rounded-pill px-3">View Details</a>
                <% } %>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
    <% }) %>
  </div>

  <% if (totalPages > 1) { %>
  <div class="d-flex justify-content-center mt-5">
    <nav aria-label="Transaction pagination">
      <ul class="pagination pagination-apex">
        <% for (let i = 1; i <= totalPages; i++) { %>
        <li class="page-item <%= i === currentPage ? 'active' : '' %>">

          <% if(currUser.role === 'user'){ %>
          <a class="page-link" href="/payment/users/transactions-history?page=<%= i %>&limit=<%= limit %>&status=<%= statusFilter %>">
            <%= i %>
          </a>
          <% } else if (currUser.role === 'admin') { %>
          <a class="page-link" href="/admin/analytics/transactions-history?page=<%= i %>&limit=<%= limit %>&status=<%= statusFilter %>">
            <%= i %>
          </a>
          <% } %>

        </li>
        <% } %>
      </ul>
    </nav>
  </div>
  <% } %>

  <% } %>

</div>