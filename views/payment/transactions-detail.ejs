<% layout('layout/boilerplate.ejs') %>

<link rel="stylesheet" href="/css/receipt.css">

<div class="receipt-page-wrapper">
  <div class="container d-flex flex-column align-items-center">

    <div class="action-buttons mb-4 gap-3 d-flex">
      <button class="btn btn-dark rounded-pill px-4 shadow-sm fw-bold" onclick="downloadPDF('<%= booking.orderID%>', this)">
        <i class="bi bi-file-earmark-pdf me-2"></i> Download PDF
      </button>
      <button class="btn btn-outline-dark rounded-pill px-4 shadow-sm fw-bold" onclick="downloadJPG('<%= booking.orderID%>', this)">
        <i class="bi bi-file-image me-2"></i> Download JPG
      </button>
    </div>

    <div id="receipt-content" class="receipt-card shadow-lg">

      <div class="receipt-header text-center mb-4">
        <div class="brand-logo mb-2">APEX SPORTS</div>
        <p class="mb-0 small text-uppercase fw-bold">Official Receipt</p>
        <p class="small text-muted mb-0">Jln. Kita Masih Panjang No. 123, Jakarta</p>
        <p class="small text-muted">(021) 1234-5678</p>
        <div class="receipt-divider my-3"></div>
      </div>

      <div class="mb-4">
        <div class="receipt-row">
          <span class="text-muted">Customer</span>
          <span class="fw-bold text-end">
            <% if(booking.user){ %>
            <%= booking.user.username %>
            <% } else { %>
            <%= booking.manual_name || 'Guest' %>
            <% } %>
          </span>
        </div>
        <div class="receipt-row">
          <span class="text-muted">Contact</span>
          <span class="fw-bold text-end">
            <% if(booking.user){ %>
            <%= booking.user.email %>
            <% } else { %>
            <%= booking.manual_contact || '-' %>
            <% } %>
          </span>
        </div>
        <div class="receipt-row">
          <span class="text-muted">Order ID</span>
          <span class="fw-bold text-end font-monospace"><%= booking.orderID %></span>
        </div>
      </div>

      <div class="receipt-divider-dashed mb-3"></div>

      <div class="mb-4">
        <div class="receipt-row mb-2">
          <span class="fw-bold">Field</span>
          <span class="fw-bold text-end"><%= field.name %></span>
        </div>
        <div class="receipt-row mb-2">
          <span class="fw-bold">Date</span>
          <span class="text-end"><%= formattedDate(booking.date) %></span>
        </div>

        <div class="mt-3">
          <span class="text-muted small d-block mb-1">Session Details:</span>
          <% booking.slots.forEach((sess, idx) => { %>
          <div class="receipt-row small mb-1">
            <span>Slot <%= idx + 1 %> (<%= minutesToHHMM(sess) %> - <%= minutesToHHMM(sess + 60) %>)</span>
            <span>Rp<%= formatPrice(booking.total_price / booking.slots.length) %></span>
          </div>
          <% }) %>
        </div>
      </div>

      <div class="receipt-divider mb-3"></div>

      <div class="mb-4">
        <div class="receipt-row total-row mb-3">
          <span class="fw-bold fs-5">TOTAL</span>
          <span class="fw-bold fs-5">Rp<%= formatPrice(booking.total_price) %></span>
        </div>

        <div class="receipt-row mb-1">
          <span class="text-muted">Payment Method</span>
          <span class="fw-bold text-end">
            <% if(booking.transaction_id){ %>
            Midtrans Gateway
            <% } else { %>
            Cash / On-site
            <% } %>
          </span>
        </div>
        <div class="receipt-row mb-1">
          <span class="text-muted">Paid At</span>
          <span class="text-end"><%= formattedDate(booking.payment_time) %></span>
        </div>
        <div class="receipt-row mt-2">
          <span class="text-muted">Status</span>
          <span class="badge bg-success text-uppercase px-2 rounded-1">Success</span>
        </div>
      </div>

      <div class="receipt-footer text-center mt-5">

        <p class="small text-muted mb-0">Thank you for playing at Apex Sports!</p>
        <p class="small text-muted" style="font-size: 0.7rem;">Generated on <%= new Date().toLocaleDateString() %></p>
      </div>

    </div>

    <% if(booking.transaction_id && currUser && currUser.role === 'admin'){ %>
    <div class="mt-4">
      <a class="btn btn-link text-muted small text-decoration-none" target="_blank" href="https://dashboard.sandbox.midtrans.com/beta/transactions?detail=<%= booking.transactionID %>">
        <i class="bi bi-shield-lock me-1"></i> Verify Transaction on Midtrans
      </a>
    </div>
    <% } %>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="/js/receiptDownload.js"></script>